package sip

// msgDef definies the required and optional fields of a message.
type msgDef struct {
	// Required fixed-length fields, identified by position in header.
	RequiredFixed []fieldType
	// Required variable-length fields, identified by two-character ID.
	// (Some might acually be fixed length, but we can parse them with same logic.)
	RequiredVar []fieldType
	// Optional variable-length fields, identified by two-character ID.
	OptionalVar []fieldType
}

var (
	msgDefinitions = map[msgType]msgDef{
		// Requests:
		MsgReqPatronStatus: msgDef{
			RequiredFixed: {
				FieldLanguage,
				FieldTransactionDate,
				FieldInstitutionID,
			},
			RequiredVar: {
				FieldPatronIdentifier,
				FieldTerminalPassword,
				FieldPatronPassword,
			},
			OptionalVar: {},
		},
		MsgReqCheckout: msgDef{
			RequiredFixed: {
				FieldRenewalPolicy,
				FieldNoBlock,
				FieldTransactionDate,
				FieldNbDueDate,
			},
			RequiredVar: {
				FieldInstitutionID,
				FieldPatronIdentifier,
				FieldItemIdentifier,
				FieldTerminalPassword,
			},
			OptionalVar: {
				FieldItemProperties,
				FieldPatronPassword,
				FieldFeeAcknowledged,
				FieldCancel,
			},
		},
		MsgReqCheckin: msgDef{
			RequiredFixed: {
				FieldNoBlock,
				FieldTransactionDate,
				FieldReturnDate,
			},
			RequiredVar: {
				FieldCurrentLocation,
				FieldInstitutionID,
				FieldItemIdentifier,
				FieldTerminalPassword,
			},
			OptionalVar: {
				FieldItemProperties,
				FieldCancel,
			},
		},
		MsgReqBlockPatron: msgDef{
			RequiredFixed: {
				FieldCardRetained,
				FieldTransactionDate,
			},
			RequiredVar: {
				FieldInstitutionID,
				FieldBlockedCardMsg,
				FieldPatronIdentifier,
				FieldTerminalPassword,
			},
			OptionalVar: {
				FieldCardRetained,
				FieldTransactionDate,
				FieldInstitutionID,
				FieldBlockedCardMsg,
				FieldPatronIdentifier,
				FieldTerminalPassword,
			},
		},
		MsgReqStatus: msgDef{
			RequiredFixed: {
				FieldStatusCode,
				FieldMaxPrintWidth,
				FieldProtocolVersion,
			},
			RequiredVar: {},
			OptionalVar: {},
		},
		MsgReqResend: msgDef{},
		MsgLogin: msgDef{
			RequiredFixed: {
				FieldUIDAlgorithm,
				FieldPWDAlgorithm,
			},
			RequiredVar: {
				FieldLoginUserID,
				FieldLoginPassword,
			},
			OptionalVar: {
				FieldLocationCode,
			},
		},
		MsgReqPatronInformation: msgDef{
			RequiredFixed: {
				FieldLanguage,
				FieldTransactionDate,
				FieldSummary,
			},
			RequiredVar: {
				FieldInstitutionID,
				FieldPatronIdentifier,
			},
			OptionalVar: {
				FieldTerminalPassword,
				FieldPatronPassword,
				FieldStartItem,
				FieldEndItem,
			},
		},
		MsgReqEndPatronSession: msgDef{
			RequiredFixed: {
				FieldTransactionDate,
			},
			RequiredVar: {
				FieldInstitutionID,
				FieldPatronIdentifier,
			},
			OptionalVar: {},
		},
		MsgReqFeePaid: msgDef{
			RequiredFixed: {
				FieldTransactionDate,
				FieldFeeType,
				FieldPaymentType,
				FieldCurrenyType,
				FieldFeeAmount,
			},
			RequiredVar: {
				FieldInstitutionID,
				FieldPatronIdentifier,
			},
			OptionalVar: {
				FieldTerminalPassword,
				FieldPatronPassword,
				FieldFeeIdentifier,
				FieldTransactionID,
			},
		},
		MsgReqItemInformation: msgDef{
			RequiredFixed: {
				FieldTransactionDate,
			},
			RequiredVar: {
				FieldInstitutionID,
				FieldItemIdentifier,
			},
			OptionalVar: {
				FieldTerminalPassword,
			},
		},
		MsgReqItemStatusUpdate: msgDef{
			RequiredFixed: {
				FieldTransactionDate,
			},
			RequiredVar: {
				FieldInstitutionID,
				FieldItemIdentifier,
			},
			OptionalVar: {
				FieldTerminalPassword,
				FieldItemProperties,
			},
		},
		MsgReqPatronEnable: msgDef{
			RequiredFixed: {
				FieldTransactionDate,
			},
			RequiredVar: {
				FieldInstitutionID,
				FieldPatronIdentifier,
			},
			OptionalVar: {
				FieldTerminalPassword,
				FieldPatronPassword,
			},
		},
		MsgReqHold: msgDef{
			RequiredFixed: {
				FieldHoldMode,
				FieldTransactionDate,
			},
			RequiredVar: {
				FieldInstitutionID,
				FieldPatronIdentifier,
			},
			OptionalVar: {
				FieldPickupLocation,
				FieldExpirationDate,
				FieldHoldType,
				FieldPatronPassword,
				FieldItemIdentifier,
				FieldTitleIdentifier,
				FieldTerminalPassword,
				FieldFeeAcknowledged,
			},
		},
		MsgReqRenew: msgDef{
			RequiredFixed: {
				FieldThirdPartyAllowd,
				FieldNoBlock,
				FieldTransactionDate,
				FieldNbDueDate,
			},
			RequiredVar: {
				FieldInstitutionID,
				FieldPatronIdentifier,
			},
			OptionalVar: {
				FieldPatronPassword,
				FieldItemIdentifier,
				FieldTitleIdentifier,
				FieldTerminalPassword,
				FieldItemProperties,
				FieldFeeAcknowledged,
			},
		},
		MsgReqRenewAll: msgDef{
			RequiredFixed: {
				FieldTransactionDate,
			},
			RequiredVar: {
				FieldInstitutionID,
				FieldPatronIdentifier,
			},
			OptionalVar: {
				FieldPatronPassword,
				FieldTerminalPassword,
				FieldFeeAcknowledged,
			},
		},
		MsgRespStatus: msgDef{
			RequiredFixed: {
				FieldPatronStatus,
				FieldLanguage,
				FieldTransactionDate,
			},
			RequiredVar: {
				FieldInstitutionID,
				FieldPatronIdentifier,
				FieldPersonalName,
			},
			OptionalVar: {
				FieldValidPatron,
				FieldValidPatronPassword,
				FieldCurrenyType,
				FieldFeeAmount,
				FieldScreenMessage,
				FieldPrintLine,
				FieldLibraryName,
				FieldTerminalLocation,
			},
		},
		// Responses:
		MsgRespCheckout: msgDef{
			RequiredFixed: {
				FieldOK,
				FieldRenewalOK,
				FieldMagneticMedia,
				FieldDesentisize,
				FieldTransactionDate,
			},
			RequiredVar: {
				FieldInstitutionID,
				FieldPatronIdentifier,
				FieldItemIdentifier,
				FieldTitleIdentifier,
				FieldDueDate,
			},
			OptionalVar: {
				FieldFeeType,
				FieldSecurityInhibit,
				FieldCurrenyType,
				FieldFeeAmount,
				FieldMediaType,
				FieldItemProperties,
				FieldTransactionID,
				FieldScreenMessage,
				FieldPrintLine,
			},
		},
		MsgRespCheckin: msgDef{
			RequiredFixed: {
				FieldOK,
				FieldResentisize,
				FieldMagneticMedia,
				FieldAlert,
				FieldTransactionDate,
			},
			RequiredVar: {
				FieldInstitutionID,
				FieldItemIdentifier,
				FieldPermanentLocation,
			},
			OptionalVar: {
				FieldTitleIdentifier,
				FieldSortBin,
				FieldMediaType,
				FieldItemProperties,
				FieldScreenMessage,
				FieldPrintLine,
			},
		},
		MsgRespStatus: msgDef{
			RequiredFixed: {
				FieldOnLineStatus,
				FieldCheckinOK,
				FieldCheckoutOK,
				FieldRenewalPolicy,
				FieldStatusUpdateOK,
				FieldOffLineOK,
				FieldTimeoutPeriod,
				FieldRetriesAllowd,
				FieldDateTimeSync,
				FieldProtocolVersion,
			},
			RequiredVar: {
				FieldInstitutionID,
				FieldSupportedMessages,
			},
			OptionalVar: {},
		},
		MsgRespLogin: msgDef{
			RequiredFixed: {
				FieldOK,
			},
			RequiredVar: {},
			OptionalVar: {},
		},
		MsgRespPatronInformation: msgDef{
			RequiredFixed: {
				FieldPatronStatus,
				FieldLanguage,
				FieldTransactionDate,
				FieldHoldItemsCount,
				FieldOverdueItemsCount,
				FieldChargedItemsCount,
				FieldFineItemsCount,
				FieldRecallItemsCount,
				FieldUnavailableHoldsCount,
			},
			RequiredVar: {
				FieldInstitutionID,
				FieldPatronIdentifier,
				FieldPersonalName,
			},
			OptionalVar: {
				FieldHoldItemsLimit,
				FieldOverdueItemsLimit,
				FieldChargedItemsLimit,
				FieldValidPatron,
				FieldValidPatronPassword,
				FieldCurrenyType,
				FieldFeeAmount,
				FieldFeeLimit,
				FieldHoldItems,
				FieldOverdueItems,
				FieldChargedItems,
				FieldFineItems,
				FieldRecallItems,
				FieldUnavailableHoldsItems,
				FieldHomeAddress,
				FieldEmailAddress,
				FieldHomePhoneNumber,
				FieldScreenMessage,
				FieldPrintLine,
			},
		},
		MsgRespEndPatronSession: msgDef{
			RequiredFixed: {
				FieldEndSession,
				FieldTransactionDate,
			},
			RequiredVar: {
				FieldInstitutionID,
				FieldPatronIdentifier,
			},
			OptionalVar: {
				FieldScreenMessage,
				FieldPrintLine,
			},
		},
		MsgRespFeePaid: msgDef{
			RequiredFixed: {
				FieldPaymentAccepted,
				FieldTransactionDate,
			},
			RequiredVar: {
				FieldInstitutionID,
				FieldPatronIdentifier,
			},
			OptionalVar: {
				FieldTransactionID,
				FieldScreenMessage,
				FieldPrintLine,
			},
		},
		MsgRespItemInformation: msgDef{
			RequiredFixed: {
				FieldCirulationStatus,
				FieldSecurityMarker,
				FieldFeeType,
				FieldTransactionDate,
			},
			RequiredVar: {},
			OptionalVar: {
				FieldHoldQueueLength,
				FieldDueDate,
				FieldRecallDate,
				FieldHoldPickupDate,
				FieldItemIdentifier,
				FieldTitleIdentifier,
				FieldOwner,
				FieldCurrenyType,
				FieldFeeAmount,
				FieldMediaType,
				FieldPermanentLocation,
				FieldCurrentLocation,
				FieldItemProperties,
				FieldScreenMessage,
				FieldPrintLine,
			},
		},
		MsgRespStatusUpdate: msgDef{
			RequiredFixed: {
				FieldItemPropertiesOK,
				FieldTransactionDate,
			},
			RequiredVar: {
				FieldPatronIdentifier,
			},
			OptionalVar: {
				FieldTitleIdentifier,
				FieldItemProperties,
				FieldScreenMessage,
				FieldPrintLine,
			},
		},
		MsgRespPatronEnable: msgDef{
			RequiredFixed: {
				FieldPatronStatus,
				FieldLanguage,
				FieldTransactionDate,
			},
			RequiredVar: {
				FieldInstitutionID,
				FieldPatronIdentifier,
				FieldPersonalName,
			},
			OptionalVar: {
				FieldValidPatron,
				FieldValidPatronPassword,
				FieldScreenMessage,
				FieldPrintLine,
			},
		},
		MsgRespHold: msgDef{
			RequiredFixed: {
				FieldOK,
				FieldAvialable,
				FieldTransactionDate,
			},
			RequiredVar: {
				FieldInstitutionID,
				FieldPatronIdentifier,
			},
			OptionalVar: {
				FieldExpirationDate,
				FieldQueuePosition,
				FieldPickupLocation,
				FieldItemIdentifier,
				FieldTitleIdentifier,
				FieldScreenMessage,
				FieldPrintLine,
			},
		},
		MsgRespRenew: msgDef{
			RequiredFixed: {
				FieldOK,
				FieldRenewalOK,
				FieldMagneticMedia,
				FieldDesentisize,
				FieldTransactionDate,
			},
			RequiredVar: {
				FieldInstitutionID,
				FieldPatronIdentifier,
				FieldItemIdentifier,
				FieldTitleIdentifier,
				FieldDueDate,
			},
			OptionalVar: {
				FieldFeeType,
				FieldSecurityInhibit,
				FieldFeeAmount,
				FieldMediaType,
				FieldItemProperties,
				FieldTransactionID,
				FieldScreenMessage,
				FieldPrintLine,
			},
		},
		MsgRespRenewAll: msgDef{
			RequiredFixed: {
				FieldOK,
				FieldRenewedCount,
				FieldUnrenewedCount,
				FieldTransactionDate,
			},
			RequiredVar: {
				FieldInstitutionID,
			},
			OptionalVar: {
				FieldRenewedItems,
				FieldUnrenewedItems,
				FieldScreenMessage,
				FieldPrintLine,
			},
		},
	}

	fixedFieldLengths = map[fieldType]int{
		FieldAlert:                 1,
		FieldAvialable:             1,
		FieldCardRetained:          1,
		FieldChargedItemsCount:     4,
		FieldFineItemsCount:        4,
		FieldHoldItemsCount:        4,
		FieldOverdueItemsCount:     4,
		FieldRecallItemsCount:      4,
		FieldUnavailableHoldsCount: 4,
		FieldCheckinOK:             1,
		FieldCheckoutOK:            1,
		FieldCirulationStatus:      2,
		FieldDateTimeSync:          18,
		FieldDesentisize:           1,
		FieldEndSession:            1,
		FieldHoldMode:              1,
		FieldItemPropertiesOK:      1,
		FieldLanguage:              3,
		FieldMagneticMedia:         1,
		FieldMaxPrintWidth:         3,
		FieldNbDueDate:             1,
		FieldNoBlock:               1,
		FieldOffLineOK:             1,
		FieldOK:                    1,
		FieldOnLineStatus:          1,
		FieldPatronStatus:          14,
		FieldPaymentAccepted:       1,
		FieldPaymentType:           2,
		FieldProtocolVersion:       4,
		FieldPWDAlgorithm:          1,
		FieldRenewalOK:             1,
		FieldRenewedCount:          4,
		FieldResentisize:           1,
		FieldRetriesAllowd:         3,
		FieldReturnDate:            18,
		FieldRenewalPolicy:         1,
		FieldSecurityMarker:        2,
		FieldStatusCode:            1,
		FieldStatusUpdateOK:        1,
		FieldSummary:               10,
		FieldThirdPartyAllowd:      1,
		FieldTimeoutPeriod:         3,
		FieldTransactionDate:       18,
		FieldUIDAlgorithm:          1,
		FieldUnrenewedCount:        4,
	}

	msgToID = map[msgType]string{
		MsgReqPatronStatus:       "23",
		MsgReqCheckout:           "11",
		MsgReqCheckin:            "09",
		MsgReqBlockPatron:        "01",
		MsgReqStatus:             "99",
		MsgReqResend:             "97",
		MsgReqLogin:              "93",
		MsgReqPatronInformation:  "63",
		MsgReqEndPatronSession:   "35",
		MsgReqFeePaid:            "37",
		MsgReqItemInformation:    "17",
		MsgReqItemStatusUpdate:   "19",
		MsgReqPatronEnable:       "25",
		MsgReqHold:               "15",
		MsgReqRenew:              "29",
		MsgReqRenewAll:           "65",
		MsgRespPatronStatus:      "24",
		MsgRespCheckout:          "12",
		MsgRespCheckin:           "10",
		MsgRespStatus:            "98",
		MsgRespLogin:             "94",
		MsgRespPatronInformation: "64",
		MsgRespEndPatronSession:  "36",
		MsgRespFeePaid:           "38",
		MsgRespItemInformation:   "18",
		MsgRespItemStatusUpdate:  "20",
		MsgRespPatronEnable:      "26",
		MsgRespHold:              "16",
		MsgRespRenew:             "30",
		MsgRespRenewAll:          "66",
	}

	idToMsg = map[string]msgType{
		"23": MsgReqPatronStatus,
		"11": MsgReqCheckout,
		"09": MsgReqCheckin,
		"01": MsgReqBlockPatron,
		"99": MsgReqStatus,
		"97": MsgReqResend,
		"93": MsgReqLogin,
		"63": MsgReqPatronInformation,
		"35": MsgReqEndPatronSession,
		"37": MsgReqFeePaid,
		"17": MsgReqItemInformation,
		"19": MsgReqItemStatusUpdate,
		"25": MsgReqPatronEnable,
		"15": MsgReqHold,
		"29": MsgReqRenew,
		"65": MsgReqRenewAll,
		"24": MsgRespPatronStatus,
		"12": MsgRespCheckout,
		"10": MsgRespCheckin,
		"98": MsgRespStatus,
		"94": MsgRespLogin,
		"64": MsgRespPatronInformation,
		"36": MsgRespEndPatronSession,
		"38": MsgRespFeePaid,
		"18": MsgRespItemInformation,
		"20": MsgRespItemStatusUpdate,
		"26": MsgRespPatronEnable,
		"16": MsgRespHold,
		"30": MsgRespRenew,
		"66": MsgRespRenewAll,
	}

	fieldToID = map[fieldType]string{
		FieldPatronIdentifier:      "AA",
		FieldItemIdentifier:        "AB",
		FieldTerminalPassword:      "AC",
		FieldPatronPassword:        "AD",
		FieldPersonalName:          "AE",
		FieldScreenMessage:         "AF",
		FieldPrintLine:             "AG",
		FieldDueDate:               "AH",
		FieldTitleIdentifier:       "AJ",
		FieldBlockedCardMsg:        "AL",
		FieldLibraryName:           "AM",
		FieldTerminalLocation:      "AN",
		FieldInstitutionID:         "AO",
		FieldCurrentLocation:       "AP",
		FieldPermanentLocation:     "AQ",
		FieldHoldItems:             "AS",
		FieldOverdueItems:          "AT",
		FieldChargedItems:          "AU",
		FieldFineItems:             "AV",
		FieldHomeAddress:           "BD",
		FieldEmailAddress:          "BE",
		FieldHomePhoneNumber:       "BF",
		FieldOwner:                 "BG",
		FieldCurrenyType:           "BH",
		FieldCancel:                "BI",
		FieldTransactionID:         "BK",
		FieldValidPatron:           "BL",
		FieldRenewedItems:          "BM",
		FieldUnrenewedItems:        "BN",
		FieldFeeAcknowledged:       "BO",
		FieldStartItem:             "BP",
		FieldEndItem:               "BQ",
		FieldQueuePosition:         "BR",
		FieldPickupLocation:        "BS",
		FieldFeeType:               "BT",
		FieldRecallItems:           "BU",
		FieldFeeAmount:             "BV",
		FieldExpirationDate:        "BW",
		FieldSupportedMessages:     "BX",
		FieldHoldType:              "BY",
		FieldHoldItemsLimit:        "BZ",
		FieldOverdueItemsLimit:     "CA",
		FieldChargedItemsLimit:     "CB",
		FieldFeeLimit:              "CC",
		FieldUnavailableHoldsItems: "CD",
		FieldHoldQueueLength:       "CF",
		FieldFeeIdentifier:         "CG",
		FieldItemProperties:        "CH",
		FieldSecurityInhibit:       "CI",
		FieldRecallDate:            "CJ",
		FieldMediaType:             "CK",
		FieldSortBin:               "CL",
		FieldHoldPickupDate:        "CM",
		FieldLoginUserID:           "CN",
		FieldLoginPassword:         "CO",
		FieldLocationCode:          "CP",
		FieldValidPatronPassword:   "CQ",
		FieldSequenceNumber:        "AY",
		FieldChecksum:              "AZ",
	}

	idToField = map[string]fieldType{
		"AA": FieldPatronIdentifier,
		"AB": FieldItemIdentifier,
		"AC": FieldTerminalPassword,
		"AD": FieldPatronPassword,
		"AE": FieldPersonalName,
		"AF": FieldScreenMessage,
		"AG": FieldPrintLine,
		"AH": FieldDueDate,
		"AJ": FieldTitleIdentifier,
		"AL": FieldBlockedCardMsg,
		"AM": FieldLibraryName,
		"AN": FieldTerminalLocation,
		"AO": FieldInstitutionID,
		"AP": FieldCurrentLocation,
		"AQ": FieldPermanentLocation,
		"AS": FieldHoldItems,
		"AT": FieldOverdueItems,
		"AU": FieldChargedItems,
		"AV": FieldFineItems,
		"BD": FieldHomeAddress,
		"BE": FieldEmailAddress,
		"BF": FieldHomePhoneNumber,
		"BG": FieldOwner,
		"BH": FieldCurrenyType,
		"BI": FieldCancel,
		"BK": FieldTransactionID,
		"BL": FieldValidPatron,
		"BM": FieldRenewedItems,
		"BN": FieldUnrenewedItems,
		"BO": FieldFeeAcknowledged,
		"BP": FieldStartItem,
		"BQ": FieldEndItem,
		"BR": FieldQueuePosition,
		"BS": FieldPickupLocation,
		"BT": FieldFeeType,
		"BU": FieldRecallItems,
		"BV": FieldFeeAmount,
		"BW": FieldExpirationDate,
		"BX": FieldSupportedMessages,
		"BY": FieldHoldType,
		"BZ": FieldHoldItemsLimit,
		"CA": FieldOverdueItemsLimit,
		"CB": FieldChargedItemsLimit,
		"CC": FieldFeeLimit,
		"CD": FieldUnavailableHoldsItems,
		"CF": FieldHoldQueueLength,
		"CG": FieldFeeIdentifier,
		"CH": FieldItemProperties,
		"CI": FieldSecurityInhibit,
		"CJ": FieldRecallDate,
		"CK": FieldMediaType,
		"CL": FieldSortBin,
		"CM": FieldHoldPickupDate,
		"CN": FieldLoginUserID,
		"CO": FieldLoginPassword,
		"CP": FieldLocationCode,
		"CQ": FieldValidPatronPassword,
		"AY": FieldSequenceNumber,
		"AZ": FieldChecksum,
	}
)
